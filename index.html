<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日语N2词汇练习</title>
    <!-- 引入Tailwind CSS框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 自定义样式 -->
    <style>
        :root {
            --primary-glow: #6366f1; /* Indigo-500 */
            --correct-glow: #10b981; /* Emerald-500 */
            --incorrect-glow: #ef4444; /* Red-500 */
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #0c0a18;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 20px 20px;
            color: #e5e7eb; /* Gray-200 */
        }

        /* 玻璃拟态效果 */
        .glass-pane {
            background: rgba(23, 21, 40, 0.6);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .card-flip-container {
            perspective: 1500px;
        }
        .card {
            transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            transform-style: preserve-3d;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .card-back {
            transform: rotateY(180deg);
        }

        .quiz-option {
            transition: all 0.2s ease-in-out;
        }
        .quiz-option:not(.disabled):hover {
            border-color: var(--primary-glow);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        .quiz-option:active {
            transform: scale(0.97);
        }
        .quiz-option.correct {
            background-color: var(--correct-glow);
            border-color: var(--correct-glow);
            color: white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        .quiz-option.incorrect {
            background-color: var(--incorrect-glow);
            border-color: var(--incorrect-glow);
            color: white;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        /* 动态背景辉光 */
        .glow-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            background-image: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 60%);
            transform: translate(-50%, -50%);
            animation: pulse 15s infinite ease-in-out;
            z-index: -1;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
            50% { transform: translate(-45%, -55%) scale(1.2); opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="glow-bg"></div>

    <!-- Vue App 容器 -->
    <div id="app" class="relative z-10 container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- 文件加载界面 -->
        <div v-if="!isFileLoaded" class="max-w-xl mx-auto text-center glass-pane p-8 sm:p-12 rounded-2xl animate-fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h1 class="text-3xl font-bold text-white mt-4 mb-4">欢迎使用日语N2词汇练习</h1>
            <p class="text-gray-300 mb-8">请先加载您的词库文件 (JSON格式)，然后开始学习和练习。</p>
            
            <label for="file-upload" class="w-full inline-block bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-200 transform hover:scale-105 cursor-pointer">
                选择JSON文件
            </label>
            <input id="file-upload" type="file" @change="handleFileUpload" class="hidden" accept=".json">

            <p v-if="errorMessage" class="mt-4 text-red-400 font-semibold">{{ errorMessage }}</p>
        </div>

        <!-- 主应用界面 (文件加载后显示) -->
        <div v-if="isFileLoaded" class="animate-fade-in">
            <!-- 页面头部 -->
            <header class="text-center mb-10">
                <h1 class="text-5xl font-bold text-white mb-2" style="text-shadow: 0 0 15px rgba(99, 102, 241, 0.5);">日语N2核心词汇练习</h1>
                <p class="text-lg text-gray-400">已加载词库: <span class="font-semibold text-indigo-400">{{ fileName }}</span></p>
                <div class="mt-8 flex justify-center space-x-4">
                    <button @click="changeMode('list')" :class="{'bg-indigo-600 text-white shadow-lg shadow-indigo-500/50': mode === 'list', 'bg-gray-700/50 text-gray-200 hover:bg-gray-700/80': mode !== 'list'}" class="px-6 py-2 font-medium rounded-lg border border-indigo-500/50 transition-all duration-200">词汇列表</button>
                    <button @click="changeMode('quiz')" :class="{'bg-indigo-600 text-white shadow-lg shadow-indigo-500/50': mode === 'quiz', 'bg-gray-700/50 text-gray-200 hover:bg-gray-700/80': mode !== 'quiz'}" class="px-6 py-2 font-medium rounded-lg border border-indigo-500/50 transition-all duration-200">练习模式</button>
                </div>
            </header>

            <main>
                <!-- 词汇列表模式 -->
                <div v-if="mode === 'list'">
                    <div class="flex justify-end mb-4">
                        <button @click="toggleShuffle" 
                                :class="isShuffled ? 'bg-teal-500 text-white' : 'bg-gray-700/50 text-gray-200'"
                                class="px-4 py-2 font-semibold rounded-lg shadow-md border border-gray-600 flex items-center transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                            {{ isShuffled ? '恢复顺序' : '乱序模式' }}
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="word in paginatedWords" :key="word.kanji + word.word" @click="selectWord(word)" class="glass-pane p-6 rounded-xl shadow-lg hover:shadow-indigo-500/20 hover:border-indigo-400 hover:-translate-y-1 transform transition-all duration-300 cursor-pointer">
                            <h3 class="text-2xl font-bold text-indigo-300">{{ word.kanji }} <span class="text-lg text-gray-400 font-normal">{{ word.word }}</span></h3>
                            <p class="text-gray-300 mt-2">{{ word.translation }}</p>
                        </div>
                    </div>
                    <div class="mt-10 flex justify-center items-center space-x-4">
                        <button @click="prevPage" :disabled="currentPage === 1" class="px-4 py-2 bg-gray-700/50 rounded-lg shadow-md border border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-transform hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>上一页</button>
                        <span class="text-gray-300 font-medium">第 {{ currentPage }} / {{ totalPages }} 页</span>
                        <button @click="nextPage" :disabled="currentPage === totalPages" class="px-4 py-2 bg-gray-700/50 rounded-lg shadow-md border border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-transform hover:scale-105">下一页<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>

                <!-- 练习模式 -->
                <div v-if="mode === 'quiz'" class="max-w-3xl mx-auto">
                    <!-- 模式选择 -->
                    <div v-if="!quizType" class="glass-pane p-8 rounded-2xl shadow-2xl text-center animate-fade-in">
                        <h2 class="text-3xl font-bold text-white mb-6">请选择练习模式</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button @click="startQuiz('kanji_to_meaning')" class="p-6 bg-indigo-500 text-white rounded-xl shadow-lg hover:bg-indigo-600 transition-all transform hover:scale-105 hover:shadow-xl">
                                <span class="text-xl font-bold">汉字 → 释义</span><br><span class="text-sm opacity-90">根据汉字选择正确的中文意思</span>
                            </button>
                            <button @click="startQuiz('kanji_to_kana')" class="p-6 bg-teal-500 text-white rounded-xl shadow-lg hover:bg-teal-600 transition-all transform hover:scale-105 hover:shadow-xl">
                                <span class="text-xl font-bold">汉字 → 假名</span><br><span class="text-sm opacity-90">根据汉字选择正确的假名读音</span>
                            </button>
                            <button @click="startQuiz('kana_to_kanji')" class="p-6 bg-amber-500 text-white rounded-xl shadow-lg hover:bg-amber-600 transition-all transform hover:scale-105 hover:shadow-xl">
                                <span class="text-xl font-bold">假名 → 汉字</span><br><span class="text-sm opacity-90">根据假名选择正确的汉字写法</span>
                            </button>
                            <button @click="startQuiz('mixed')" class="p-6 bg-rose-500 text-white rounded-xl shadow-lg hover:bg-rose-600 transition-all transform hover:scale-105 hover:shadow-xl">
                                <span class="text-xl font-bold">混合模式</span><br><span class="text-sm opacity-90">随机混合以上三种题型</span>
                            </button>
                        </div>
                    </div>

                    <!-- 答题界面 -->
                    <div v-if="quizType && !quizFinished" class="glass-pane p-8 rounded-2xl shadow-2xl">
                        <div class="text-center mb-8">
                            <p class="text-lg text-gray-400 mb-2">问题 {{ currentQuestionIndex + 1 }} / {{ quizWords.length }}</p>
                            <h2 class="text-5xl font-bold text-white mb-4">{{ currentQuestion.question }}</h2>
                            <p v-if="currentQuestion.type === 'kanji_to_meaning'" class="text-2xl text-gray-400">{{ currentQuestion.word.word }}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button v-for="(option, index) in currentQuestion.options" :key="index" @click="checkAnswer(option)"
                                    :class="['quiz-option p-4 text-lg font-medium rounded-lg border-2 border-gray-600 bg-gray-800/50 text-gray-200', optionClass(option), {'disabled': answered}]">
                                {{ option }}
                            </button>
                        </div>
                        
                        <div v-if="answered && (currentQuestion.type === 'kanji_to_kana' || currentQuestion.type === 'kana_to_kanji')" 
                             class="mt-6 p-4 bg-gray-800/50 border-l-4 border-indigo-500 rounded-r-lg animate-fade-in">
                            <p class="text-lg font-bold text-indigo-300">{{ currentQuestion.word.kanji }} [{{ currentQuestion.word.word }}]</p>
                            <p class="mt-1 text-gray-300"><strong>释义：</strong> {{ currentQuestion.word.translation }}</p>
                            <p v-if="currentQuestion.word.example" class="mt-1 text-gray-400"><strong>例句：</strong> {{ currentQuestion.word.example }}</p>
                        </div>

                        <div class="mt-8 text-center">
                             <button v-if="answered" @click="nextQuestion" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg shadow-indigo-500/50 hover:bg-indigo-700 transition-transform transform hover:scale-105">下一题</button>
                        </div>
                    </div>
                    
                    <!-- 练习结果 -->
                    <div v-if="quizFinished" class="glass-pane p-8 rounded-2xl shadow-2xl text-center">
                        <h2 class="text-3xl font-bold text-white mb-4">练习结束！</h2>
                        <p class="text-xl text-gray-400 mb-6">您的得分是： <span class="font-bold text-indigo-400 text-2xl">{{ score }} / {{ quizWords.length }}</span></p>
                        <div class="mb-6">
                            <h3 class="text-2xl font-semibold mb-3">答错的单词</h3>
                            <ul v-if="incorrectAnswers.length > 0" class="list-disc list-inside text-left max-w-md mx-auto bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                                <li v-for="item in incorrectAnswers" :key="item.word.kanji" class="text-lg mb-2">
                                    <span class="font-bold">{{ item.word.kanji }} ({{ item.word.word }})</span>: {{ item.word.translation }}
                                </li>
                            </ul>
                            <p v-else class="text-gray-400 mt-4">太棒了！没有答错的单词。</p>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button @click="resetQuiz" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-gray-700 transition-transform transform hover:scale-105">返回模式选择</button>
                            <button @click="startQuiz(quizType)" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg shadow-indigo-500/50 hover:bg-indigo-700 transition-transform transform hover:scale-105">再试一次</button>
                        </div>
                    </div>
                </div>

                <!-- 单词详情弹窗 -->
                <div v-if="selectedWord" @click.self="selectedWord = null" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                     <div class="glass-pane rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95" :class="{'scale-100': selectedWord}">
                        <div class="card-flip-container relative w-full h-96" @click="flipCard">
                            <div class="card absolute w-full h-full" :class="{'is-flipped': cardFlipped}">
                                <!-- 卡片正面 -->
                                <div class="card-face bg-indigo-600 text-white p-8 rounded-2xl flex flex-col justify-center items-center cursor-pointer shadow-2xl">
                                    <h2 class="text-6xl font-bold">{{ selectedWord.kanji }}</h2>
                                    <p class="text-3xl mt-2 opacity-80">{{ selectedWord.word }}</p>
                                    <p class="absolute bottom-4 text-sm opacity-60">点击卡片查看释义</p>
                                </div>
                                <!-- 卡片背面 -->
                                <div class="card-back bg-gray-800 text-white p-8 rounded-2xl flex flex-col justify-start">
                                    <div>
                                        <h3 class="text-2xl font-bold text-indigo-300 mb-3">释义</h3>
                                        <p class="text-lg text-gray-300 mb-4">{{ selectedWord.translation }}</p>
                                        <h3 v-if="selectedWord.example" class="text-xl font-bold text-indigo-300 mb-2">例句</h3>
                                        <p v-if="selectedWord.example" class="text-md text-gray-300" v-html="selectedWord.example.replace(/\n/g, '<br>')"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-900/50 rounded-b-2xl flex justify-end border-t border-gray-700">
                             <button @click="selectedWord = null" class="px-6 py-2 bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-colors">关闭</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- 引入Vue.js框架 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 主应用逻辑脚本 -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    words: [], // 存储从JSON加载的完整词库
                    originalWords: [], // 存储原始顺序的词库
                    isFileLoaded: false, // 控制主应用是否显示
                    fileName: '', // 已加载的文件名
                    errorMessage: '', // 文件加载错误信息
                    mode: 'list', // 当前模式: 'list' 或 'quiz'
                    isShuffled: false, // 词汇列表是否乱序
                    selectedWord: null, // 词汇列表模式下选中的单词
                    cardFlipped: false, // 单词详情卡片是否翻转
                    // 练习模式相关数据
                    quizType: null,
                    quizWords: [],
                    currentQuestionIndex: 0,
                    score: 0,
                    answered: false,
                    selectedAnswer: '',
                    incorrectAnswers: [],
                    quizFinished: false,
                    // 分页相关数据
                    currentPage: 1,
                    itemsPerPage: 12,
                }
            },
            computed: {
                currentQuestion() {
                    return this.quizWords.length > 0 ? this.quizWords[this.currentQuestionIndex] : null;
                },
                totalPages() {
                    return this.words.length > 0 ? Math.ceil(this.words.length / this.itemsPerPage) : 1;
                },
                paginatedWords() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.words.slice(start, end);
                }
            },
            methods: {
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            let data = JSON.parse(e.target.result);
                            // FIX: Standardize 'definition' to 'translation'
                            data = data.map(item => {
                                if (item.definition && !item.translation) {
                                    item.translation = item.definition;
                                    delete item.definition;
                                }
                                return item;
                            });

                            // 验证JSON文件格式
                            if (Array.isArray(data) && data.length > 0 && 'kanji' in data[0] && 'word' in data[0] && 'translation' in data[0]) {
                                this.words = [...data];
                                this.originalWords = [...data]; // 保存原始顺序
                                this.isFileLoaded = true;
                                this.fileName = file.name;
                                this.errorMessage = '';
                            } else {
                                throw new Error('无效的词库文件格式。');
                            }
                        } catch (error) {
                            console.error("加载或解析文件失败:", error);
                            this.errorMessage = '加载失败！请确保文件是正确的JSON格式。';
                        }
                    };
                    reader.onerror = (error) => {
                        console.error("读取文件失败:", error);
                        this.errorMessage = '读取文件时发生错误。';
                    };
                    reader.readAsText(file);
                },
                changeMode(newMode) {
                    this.mode = newMode;
                    if (newMode === 'quiz') this.resetQuiz();
                },
                resetQuiz() {
                    this.quizType = null;
                    this.quizFinished = false;
                },
                selectWord(word) {
                    this.selectedWord = word;
                    this.cardFlipped = false;
                },
                flipCard() {
                    this.cardFlipped = !this.cardFlipped;
                },
                shuffleArray(array) {
                    let newArr = [...array];
                    for (let i = newArr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                    }
                    return newArr;
                },
                toggleShuffle() {
                    this.isShuffled = !this.isShuffled;
                    if (this.isShuffled) {
                        this.words = this.shuffleArray(this.words);
                    } else {
                        this.words = [...this.originalWords];
                    }
                    this.currentPage = 1; // 重置到第一页
                },
                startQuiz(type) {
                    this.quizType = type;
                    this.quizFinished = false;
                    this.score = 0;
                    this.currentQuestionIndex = 0;
                    this.incorrectAnswers = [];
                    
                    let questionPool = this.words.filter(w => w.kanji && w.word);
                    if(type === 'kanji_to_kana' || type === 'kana_to_kanji' || (type === 'mixed' && Math.random() > 0.3)){
                        questionPool = questionPool.filter(w => w.kanji !== w.word);
                    }

                    const shuffledWords = this.shuffleArray([...questionPool]);
                    const selectedQuizWords = shuffledWords.slice(0, 20);

                    this.quizWords = selectedQuizWords.map(word => {
                        let currentType = type;
                        if (type === 'mixed') {
                            const types = ['kanji_to_meaning', 'kanji_to_kana', 'kana_to_kanji'];
                            currentType = (word.kanji === word.word) ? 'kanji_to_meaning' : types[Math.floor(Math.random() * types.length)];
                        }
                        return this.generateQuestion(word, currentType);
                    });
                    this.answered = false;
                    this.selectedAnswer = '';
                },
                generatePhoneticDistractors(reading, count = 3) {
                    const distractors = new Set();
                    const chars = reading.split('');
                    const dakutenMap = {'か':'が','き':'ぎ','く':'ぐ','け':'げ','こ':'ご','さ':'ざ','し':'じ','す':'ず','せ':'ぜ','そ':'ぞ','た':'だ','ち':'ぢ','つ':'づ','て':'で','と':'ど','は':'ば','ひ':'び','ふ':'ぶ','へ':'べ','ほ':'ぼ'};
                    const reverseDakutenMap = Object.fromEntries(Object.entries(dakutenMap).map(a => a.reverse()));
                    const yoonMap = {'ゃ':'や','ゅ':'ゆ','ょ':'よ'};
                    
                    for (let i = 0; i < chars.length; i++) {
                        const originalChar = chars[i];
                        let newReading;
                        if (i > 0 && ['う', 'い', 'お'].includes(originalChar) && !['あ','い','う','え','お'].includes(chars[i-1])) {
                           newReading = [...chars];
                           newReading.splice(i, 1);
                           distractors.add(newReading.join(''));
                        }
                        if (dakutenMap[originalChar]) distractors.add(reading.substring(0, i) + dakutenMap[originalChar] + reading.substring(i + 1));
                        if (reverseDakutenMap[originalChar]) distractors.add(reading.substring(0, i) + reverseDakutenMap[originalChar] + reading.substring(i + 1));
                        if (originalChar === 'っ') {
                             newReading = [...chars];
                             newReading.splice(i, 1);
                             distractors.add(newReading.join(''));
                        }
                        if (yoonMap[originalChar]) distractors.add(reading.substring(0, i) + yoonMap[originalChar] + reading.substring(i + 1));
                    }
                    
                    distractors.delete(reading);
                    const shuffled = this.shuffleArray(Array.from(distractors));
                    
                    if(shuffled.length < count) {
                        const fallback = this.getJLPTStyleDistractors({word: '', kanji: '', reading: reading}, 'word', count - shuffled.length);
                        fallback.forEach(f => { if(shuffled.length < count && !shuffled.includes(f)) shuffled.push(f); });
                    }
                    return shuffled.slice(0, count);
                },
                getJLPTStyleDistractors(correctWord, property, count = 3) {
                    const distractors = new Set();
                    const allWords = this.words;

                    if (property === 'kanji') { // For kana_to_kanji
                        const homophones = allWords.filter(w => w.word === correctWord.word && w.kanji !== correctWord.kanji);
                        this.shuffleArray(homophones).forEach(w => { if (distractors.size < count) distractors.add(w.kanji); });
                    }

                    if (distractors.size < count) {
                        const correctKanjiChars = correctWord.kanji.split('').filter(char => /\p{Script=Han}/u.test(char));
                        if (correctKanjiChars.length > 0) {
                            const relatedWords = allWords.filter(w => {
                                if (w.kanji === correctWord.kanji) return false;
                                const wordKanji = w.kanji.split('');
                                return correctKanjiChars.some(kanji => wordKanji.includes(kanji));
                            });
                            this.shuffleArray(relatedWords).forEach(w => {
                                if (distractors.size < count && w[property] !== correctWord[property] && !distractors.has(w[property])) distractors.add(w[property]);
                            });
                        }
                    }
                    
                    while (distractors.size < count) {
                        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                        if (randomWord[property] !== correctWord[property] && !distractors.has(randomWord[property])) distractors.add(randomWord[property]);
                    }
                    return Array.from(distractors);
                },
                generateQuestion(word, type) {
                    let question, answer, options;
                    
                    switch (type) {
                        case 'kanji_to_kana':
                            question = word.kanji;
                            answer = word.word;
                            options = this.shuffleArray([answer, ...this.generatePhoneticDistractors(answer)]);
                            break;
                        case 'kana_to_kanji':
                            question = word.word;
                            answer = word.kanji;
                            options = this.shuffleArray([answer, ...this.getJLPTStyleDistractors(word, 'kanji')]);
                            break;
                        case 'kanji_to_meaning':
                        default:
                            question = word.kanji;
                            answer = word.translation;
                            options = this.shuffleArray([answer, ...this.getJLPTStyleDistractors(word, 'translation')]);
                            break;
                    }
                    return { word, type, question, answer, options };
                },
                checkAnswer(option) {
                    if (this.answered) return;
                    this.answered = true;
                    this.selectedAnswer = option;
                    if (option === this.currentQuestion.answer) {
                        this.score++;
                    } else {
                        this.incorrectAnswers.push(this.currentQuestion);
                    }
                },
                optionClass(option) {
                    if (!this.answered) return '';
                    if (option === this.currentQuestion.answer) return 'correct';
                    if (option === this.selectedAnswer && option !== this.currentQuestion.answer) return 'incorrect';
                    return '';
                },
                nextQuestion() {
                    if (this.currentQuestionIndex < this.quizWords.length - 1) {
                        this.currentQuestionIndex++;
                        this.answered = false;
                        this.selectedAnswer = '';
                    } else {
                        this.quizFinished = true;
                    }
                },
                nextPage() {
                    if (this.currentPage < this.totalPages) this.currentPage++;
                },
                prevPage() {
                    if (this.currentPage > 1) this.currentPage--;
                }
            },
            mounted() {
                // The app starts by waiting for a file upload.
            }
        }).mount('#app');
    </script>
</body>
</html>

